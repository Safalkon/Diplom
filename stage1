# ИТОГОВЫЙ ОТЧЕТ: ЭТАП 1 - СЕТЕВАЯ ИНФРАСТРУКТУРА

## 1. Краткое описание
Создана сетевая инфраструктура для отказоустойчивого веб-сайта в Yandex Cloud. Реализована VPC сеть с публичными и приватными подсетями, NAT Gateway для исходящего трафика, Security Groups для каждого типа сервисов и Application Load Balancer для распределения трафика.

## 2. Архитектурная схема и обзор

### Текстовая схема архитектуры:
[Интернет] ↔ [Application Load Balancer (публичный IP)] ↔ [VPC: safalkon-main-vpc] | +-----------------------------+-----------------------------+ | | | [Публичная подсеть] [Приватная подсеть A] [Приватная подсеть B] 10.0.0.0/24 (зона A) 10.0.1.0/24 (зона A) 10.0.2.0/24 (зона B) | | | +-------+-------+ +-------+-------+ +-------+ | | | | | | | [Bastion] [Zabbix] [Kibana] [Web Server 1] [Elasticsearch] [Web Server 2] (public IP) (private IP) (private IP)


### Список созданных ресурсов Yandex Cloud:
1. **VPC сеть:** `safalkon-main-vpc` - основная облачная сеть
2. **Подсети:**
   - `safalkon-public-subnet-a` - публичная подсеть в зоне ru-central1-a (10.0.0.0/24)
   - `safalkon-private-subnet-a` - приватная подсеть в зоне ru-central1-a (10.0.1.0/24)
   - `safalkon-private-subnet-b` - приватная подсеть в зоне ru-central1-b (10.0.2.0/24)
   - `safalkon-infra-subnet-a` - инфраструктурная подсеть в зоне ru-central1-a (10.0.3.0/24)
3. **NAT Gateway:** `safalkon-nat-gateway` - для исходящего интернет-доступа приватных подсетей
4. **Security Groups:**
   - `safalkon-bastion-sg` - для bastion хоста (SSH 22)
   - `safalkon-web-sg` - для web-серверов (HTTP 80 от ALB, SSH от bastion)
   - `safalkon-alb-sg` - для Application Load Balancer (HTTP 80)
   - `safalkon-zabbix-sg` - для Zabbix (HTTP 80/443, Zabbix агенты)
   - `safalkon-kibana-sg` - для Kibana (HTTP 5601)
   - `safalkon-elasticsearch-sg` - для Elasticsearch (9200-9300)
5. **Application Load Balancer:**
   - `safalkon-web-alb` - балансировщик с публичным IP
   - `safalkon-web-router` - HTTP роутер
   - `safalkon-web-backend-group` - группа бэкендов
   - `safalkon-web-target-group` - целевая группа (пока пустая)

## 3. Код и конфигурационные файлы

### 3.1 Код Terraform

#### Файл: `main.tf`
```hcl
provider "yandex" {
  token     = var.yc_token
  cloud_id  = var.yc_cloud_id
  folder_id = var.yc_folder_id
  zone      = "ru-central1-a"
}

resource "yandex_vpc_network" "main-vpc" {
  name        = "safalkon-main-vpc"
  description = "Основная VPC сеть для дипломного проекта"
}

resource "yandex_vpc_subnet" "public-subnet-a" {
  name           = "safalkon-public-subnet-a"
  description    = "Публичная подсеть для bastion, zabbix, kibana, ALB"
  zone           = "ru-central1-a"
  network_id     = yandex_vpc_network.main-vpc.id
  v4_cidr_blocks = ["10.0.0.0/24"]
  route_table_id = yandex_vpc_route_table.public-route.id
}

resource "yandex_vpc_subnet" "private-subnet-a" {
  name           = "safalkon-private-subnet-a"
  description    = "Приватная подсеть для web-сервера 1"
  zone           = "ru-central1-a"
  network_id     = yandex_vpc_network.main-vpc.id
  v4_cidr_blocks = ["10.0.1.0/24"]
  route_table_id = yandex_vpc_route_table.nat-route.id
}

resource "yandex_vpc_subnet" "private-subnet-b" {
  name           = "safalkon-private-subnet-b"
  description    = "Приватная подсеть для web-сервера 2"
  zone           = "ru-central1-b"
  network_id     = yandex_vpc_network.main-vpc.id
  v4_cidr_blocks = ["10.0.2.0/24"]
  route_table_id = yandex_vpc_route_table.nat-route.id
}

resource "yandex_vpc_subnet" "infra-subnet-a" {
  name           = "safalkon-infra-subnet-a"
  description    = "Подсеть для Elasticsearch"
  zone           = "ru-central1-a"
  network_id     = yandex_vpc_network.main-vpc.id
  v4_cidr_blocks = ["10.0.3.0/24"]
  route_table_id = yandex_vpc_route_table.nat-route.id
}
Файл: nat-gateway.tf
resource "yandex_vpc_gateway" "nat-gateway" {
  name = "safalkon-nat-gateway"
  shared_egress_gateway {}
}

resource "yandex_vpc_route_table" "nat-route" {
  name       = "safalkon-nat-route"
  network_id = yandex_vpc_network.main-vpc.id

  static_route {
    destination_prefix = "0.0.0.0/0"
    gateway_id         = yandex_vpc_gateway.nat-gateway.id
  }
}

resource "yandex_vpc_route_table" "public-route" {
  name       = "safalkon-public-route"
  network_id = yandex_vpc_network.main-vpc.id
}
Файл: security-groups.tf
resource "yandex_vpc_security_group" "bastion-sg" {
  name        = "safalkon-bastion-sg"
  description = "Security group для bastion host"
  network_id  = yandex_vpc_network.main-vpc.id

  ingress {
    protocol       = "TCP"
    description    = "SSH access from anywhere"
    v4_cidr_blocks = ["0.0.0.0/0"]
    port           = 22
  }

  egress {
    protocol       = "ANY"
    description    = "Allow all outgoing traffic"
    v4_cidr_blocks = ["0.0.0.0/0"]
    from_port      = 0
    to_port        = 65535
  }
}

resource "yandex_vpc_security_group" "web-sg" {
  name        = "safalkon-web-sg"
  description = "Security group для web-серверов"
  network_id  = yandex_vpc_network.main-vpc.id

  ingress {
    protocol          = "TCP"
    description       = "HTTP from ALB"
    security_group_id = yandex_vpc_security_group.alb-sg.id
    port              = 80
  }

  ingress {
    protocol          = "TCP"
    description       = "SSH from bastion"
    security_group_id = yandex_vpc_security_group.bastion-sg.id
    port              = 22
  }

  ingress {
    protocol          = "TCP"
    description       = "Zabbix Agent traffic"
    security_group_id = yandex_vpc_security_group.zabbix-sg.id
    from_port         = 10050
    to_port           = 10051
  }

  ingress {
    protocol          = "TCP"
    description       = "Filebeat to Elasticsearch"
    security_group_id = yandex_vpc_security_group.elasticsearch-sg.id
    port              = 9200
  }

  egress {
    protocol       = "ANY"
    description    = "Allow all outgoing traffic"
    v4_cidr_blocks = ["0.0.0.0/0"]
    from_port      = 0
    to_port        = 65535
  }
}

resource "yandex_vpc_security_group" "alb-sg" {
  name        = "safalkon-alb-sg"
  description = "Security group для Application Load Balancer"
  network_id  = yandex_vpc_network.main-vpc.id

  ingress {
    protocol       = "TCP"
    description    = "HTTP from anywhere"
    v4_cidr_blocks = ["0.0.0.0/0"]
    port           = 80
  }

  egress {
    protocol       = "ANY"
    description    = "Allow all outgoing traffic"
    v4_cidr_blocks = ["0.0.0.0/0"]
    from_port      = 0
    to_port        = 65535
  }
}

resource "yandex_vpc_security_group" "zabbix-sg" {
  name        = "safalkon-zabbix-sg"
  description = "Security group для Zabbix"
  network_id  = yandex_vpc_network.main-vpc.id

  ingress {
    protocol       = "TCP"
    description    = "HTTP from anywhere"
    v4_cidr_blocks = ["0.0.0.0/0"]
    port           = 80
  }

  ingress {
    protocol       = "TCP"
    description    = "HTTPS from anywhere"
    v4_cidr_blocks = ["0.0.0.0/0"]
    port           = 443
  }

  ingress {
    protocol          = "TCP"
    description       = "Zabbix Agent traffic"
    security_group_id = yandex_vpc_security_group.web-sg.id
    from_port         = 10050
    to_port           = 10051
  }

  egress {
    protocol       = "ANY"
    description    = "Allow all outgoing traffic"
    v4_cidr_blocks = ["0.0.0.0/0"]
    from_port      = 0
    to_port        = 65535
  }
}

resource "yandex_vpc_security_group" "kibana-sg" {
  name        = "safalkon-kibana-sg"
  description = "Security group для Kibana"
  network_id  = yandex_vpc_network.main-vpc.id

  ingress {
    protocol       = "TCP"
    description    = "Kibana web interface"
    v4_cidr_blocks = ["0.0.0.0/0"]
    port           = 5601
  }

  egress {
    protocol       = "ANY"
    description    = "Allow all outgoing traffic"
    v4_cidr_blocks = ["0.0.0.0/0"]
    from_port      = 0
    to_port        = 65535
  }
}

resource "yandex_vpc_security_group" "elasticsearch-sg" {
  name        = "safalkon-elasticsearch-sg"
  description = "Security group для Elasticsearch"
  network_id  = yandex_vpc_network.main-vpc.id

  ingress {
    protocol          = "TCP"
    description       = "Elasticsearch REST API from Kibana"
    security_group_id = yandex_vpc_security_group.kibana-sg.id
    port              = 9200
  }

  ingress {
    protocol          = "TCP"
    description       = "Elasticsearch transport from itself"
    security_group_id = yandex_vpc_security_group.elasticsearch-sg.id
    port              = 9300
  }

  ingress {
    protocol          = "TCP"
    description       = "Filebeat from web servers"
    security_group_id = yandex_vpc_security_group.web-sg.id
    port              = 9200
  }

  egress {
    protocol       = "ANY"
    description    = "Allow all outgoing traffic"
    v4_cidr_blocks = ["0.0.0.0/0"]
    from_port      = 0
    to_port        = 65535
  }
}
Файл: load-balancer.tf
resource "yandex_alb_target_group" "web-target-group" {
  name = "safalkon-web-target-group"

  dynamic "target" {
    for_each = []
    content {}
  }
}

resource "yandex_alb_backend_group" "web-backend-group" {
  name = "safalkon-web-backend-group"

  http_backend {
    name             = "web-backend"
    weight           = 1
    port             = 80
    target_group_ids = [yandex_alb_target_group.web-target-group.id]
    
    healthcheck {
      timeout  = "1s"
      interval = "2s"
      
      http_healthcheck {
        path = "/"
      }
    }
  }
}

resource "yandex_alb_http_router" "web-router" {
  name = "safalkon-web-router"
}

resource "yandex_alb_virtual_host" "web-host" {
  name           = "safalkon-web-host"
  http_router_id = yandex_alb_http_router.web-router.id
  
  route {
    name = "web-route"
    http_route {
      http_route_action {
        backend_group_id = yandex_alb_backend_group.web-backend-group.id
        timeout          = "3s"
      }
    }
  }
}

resource "yandex_alb_load_balancer" "web-alb" {
  name        = "safalkon-web-alb"
  network_id  = yandex_vpc_network.main-vpc.id
  security_group_ids = [yandex_vpc_security_group.alb-sg.id]

  allocation_policy {
    location {
      zone_id   = "ru-central1-a"
      subnet_id = yandex_vpc_subnet.public-subnet-a.id
    }
  }

  listener {
    name = "http-listener"
    endpoint {
      address {
        external_ipv4_address {}
      }
      ports = [80]
    }
    http {
      handler {
        http_router_id = yandex_alb_http_router.web-router.id
      }
    }
  }
}
Файл: variables.tf
variable "yc_token" {
  type        = string
  description = "Yandex Cloud OAuth token"
  sensitive   = true
}

variable "yc_cloud_id" {
  type        = string
  description = "Yandex Cloud ID"
}

variable "yc_folder_id" {
  type        = string
  description = "Yandex Cloud folder ID"
}

variable "ssh_key_path" {
  type        = string
  description = "Path to SSH public key"
  default     = "~/.ssh/id_rsa.pub"
}
Файл: outputs.tf
output "vpc_id" {
  value       = yandex_vpc_network.main-vpc.id
  description = "ID созданной VPC"
}

output "public_subnet_a_id" {
  value       = yandex_vpc_subnet.public-subnet-a.id
  description = "ID публичной подсети в зоне A"
}

output "private_subnet_a_id" {
  value       = yandex_vpc_subnet.private-subnet-a.id
  description = "ID приватной подсети для web1 в зоне A"
}

output "private_subnet_b_id" {
  value       = yandex_vpc_subnet.private-subnet-b.id
  description = "ID приватной подсети для web2 в зоне B"
}

output "infra_subnet_a_id" {
  value       = yandex_vpc_subnet.infra-subnet-a.id
  description = "ID инфраструктурной подсети в зоне A"
}

output "security_group_ids" {
  value = {
    bastion      = yandex_vpc_security_group.bastion-sg.id
    web          = yandex_vpc_security_group.web-sg.id
    alb          = yandex_vpc_security_group.alb-sg.id
    zabbix       = yandex_vpc_security_group.zabbix-sg.id
    kibana       = yandex_vpc_security_group.kibana-sg.id
    elasticsearch = yandex_vpc_security_group.elasticsearch-sg.id
  }
  description = "ID всех Security Groups"
}

output "alb_public_ip" {
  value       = yandex_alb_load_balancer.web-alb.listener[*].endpoint[*].address[*].external_ipv4_address[*].address
  description = "Публичный IP адрес Application Load Balancer"
}

output "target_group_id" {
  value       = yandex_alb_target_group.web-target-group.id
  description = "ID Target Group для web-серверов"
}
3.2 Конфигурационные файлы
Файл: terraform.tfvars.example (шаблон для ваших значений)

yc_token     = "your_oauth_token_here"
yc_cloud_id  = "your_cloud_id_here"
yc_folder_id = "your_folder_id_here"
ssh_key_path = "~/.ssh/id_rsa.pub"
Файл: .gitignore (обязательно!)

*.tfstate
*.tfstate.*
.terraform/
terraform.tfvars
*.tfvars.json
.terraform.lock.hcl
4. Инструкции по развертыванию (Этап 1)
Шаг 1: Подготовка
# 1. Создайте SSH ключ если нет
ssh-keygen -t rsa -b 2048 -f ~/.ssh/id_rsa -N ""

# 2. Получите токен и ID из Yandex Cloud
#    - OAuth токен: https://oauth.yandex.ru/authorize?response_type=token&client_id=1a6990aa636648e9b2ef855fa7bec2fb
#    - Cloud ID: yc resource-manager cloud list
#    - Folder ID: yc resource-manager folder list

# 3. Создайте файл terraform.tfvars
cp terraform.tfvars.example terraform.tfvars
# Отредактируйте terraform.tfvars с вашими значениями
Шаг 2: Инициализация Terraform
terraform init
Шаг 3: План развертывания
terraform plan
Шаг 4: Применение конфигурации
terraform apply
# Подтвердите вводом "yes"
Шаг 5: Проверка развертывания
# Просмотр выходных значений
terraform output

# Проверка ALB IP
terraform output alb_public_ip
5. Команды для проверки и верификации
# Проверка созданных ресурсов через CLI Yandex Cloud
yc vpc network list
yc vpc subnet list
yc vpc security-group list
yc alb load-balancer list
yc alb target-group list

# Проверка IP адреса балансировщика
ALB_IP=$(terraform output -raw alb_public_ip)
echo "ALB IP: $ALB_IP"

# Проверка доступности ALB (ожидаем 404 так как нет backend серверов)
curl -I http://$ALB_IP
6. Примечания и допущения
Допущения:
Токен Yandex Cloud будет предоставлен пользователем через переменные или environment
SSH ключ существует по пути ~/.ssh/id_rsa.pub
Достаточно квот в Yandex Cloud для создания всех ресурсов
Preemptible ВМ используются для экономии, перед сдачей будут заменены на обычные
Рекомендации по безопасности:
Никогда не коммитьте terraform.tfvars в git
Используйте менеджер секретов (Hashicorp Vault, AWS Secrets Manager) для хранения токенов
Ограничьте SSH доступ к bastion только с доверенных IP адресов
Регулярно обновляйте Security Group правила
Включите мониторинг изменений инфраструктуры через Terraform Cloud/Enterprise
Замечания:
Target Group пока пустая - будет заполнена на Этапе 2 при создании ВМ
Все Security Groups настроены с минимальными необходимыми правилами
NAT Gateway обеспечивает исходящий доступ всем приватным подсетям
DNS имена .ru-central1.internal будут автоматически работать для всех ВМ
7. Следующие шаги
ЭТАП 2: Создание ВМ:

2 web-сервера в приватных подсетях
1 bastion host в публичной подсети
Добавление ВМ в Target Group
ЭТАП 3: Настройка Zabbix для мониторинга

ЭТАП 4: Развертывание ELK стека для логирования

ЭТАП 5: Настройка резервного копирования

ЭТАП 6: Конфигурация Ansible для управления