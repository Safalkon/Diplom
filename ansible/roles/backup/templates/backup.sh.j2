#!/bin/bash
# Backup script for configuration files
# Managed by Ansible

BACKUP_DIR="/backup"
DATE=$(date +%Y%m%d_%H%M%S)
RETENTION_DAYS=7

# Create backup
mkdir -p $BACKUP_DIR/$DATE

# Backup important configs
cp -r /etc/nginx $BACKUP_DIR/$DATE/ 2>/dev/null || true
cp -r /etc/zabbix $BACKUP_DIR/$DATE/ 2>/dev/null || true
cp -r /etc/elasticsearch $BACKUP_DIR/$DATE/ 2>/dev/null || true
cp -r /etc/kibana $BACKUP_DIR/$DATE/ 2>/dev/null || true
cp -r /etc/filebeat $BACKUP_DIR/$DATE/ 2>/dev/null || true

# Create tarball
cd $BACKUP_DIR
tar czf $DATE.tar.gz $DATE
rm -rf $DATE

# Upload to Yandex Object Storage (optional)
# export AWS_ACCESS_KEY_ID=...
# export AWS_SECRET_ACCESS_KEY=...
# aws --endpoint-url=https://storage.yandexcloud.net s3 cp $DATE.tar.gz s3://backup-bucket/

# Remove old backups
find $BACKUP_DIR -name "*.tar.gz" -mtime +$RETENTION_DAYS -delete

echo "Backup completed: $BACKUP_DIR/$DATE.tar.gz"